<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Synan: /common/COMSyntaxHolder.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>/common/COMSyntaxHolder.cpp</h1><div class="fragment"><pre class="fragment"><span class="preprocessor">#include "COMSyntaxHolder.h"</span>


<span class="preprocessor">#define COM_TRY try {</span>
<span class="preprocessor"></span><span class="preprocessor">#define COM_CATCH(msg) }  catch(...) { ErrorMessage(msg); return FALSE; }</span>
<span class="preprocessor"></span>
CCOMSyntaxHolder::CCOMSyntaxHolder()
{
};

CCOMSyntaxHolder::~CCOMSyntaxHolder()
{
        DeleteMorphDicts();
};



BOOL CCOMSyntaxHolder::LoadSyntaxModule(MorphLanguageEnum langua)
{
        <span class="keywordflow">try</span>
        {       
                m_piSentCollection = 0;
                HRESULT hr = m_piSentCollection.CreateInstance(__uuidof(SYNANLib::SentencesCollection));
                <span class="keywordflow">if</span>( FAILED(hr) )
                {
                        ErrorMessage(<span class="stringliteral">"SynAn has crushed, maybe \"SynAn.dll\" is not registered."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }
                
                m_piSentCollection-&gt;SyntaxLanguage = langua;
                m_piSentCollection-&gt;SetLemmatizer(m_piLemmatizer);
                
                
                <span class="keywordflow">if</span> (langua != morphRussian)
                {
                        m_piSentCollection-&gt;EnableThesauri = FALSE;
                };

                m_piSentCollection-&gt;KillHomonymsMode = CoverageKillHomonyms;

        
                hr = m_piSentCollection-&gt;InitializeProcesser();
                <span class="keywordflow">if</span>( FAILED(hr) )
                {
                        ErrorMessage(<span class="stringliteral">"Can not load syntax dictionaries."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }
                
        }
        <span class="keywordflow">catch</span>(...)
        {
                ErrorMessage(<span class="stringliteral">"SynAn has crushed, maybe \"SynAn.dll\" is not registered."</span>);
                <span class="keywordflow">return</span> FALSE;
        }
        <span class="keywordflow">return</span> TRUE;
};

BOOL CCOMSyntaxHolder::LoadSyntax(MorphLanguageEnum langua)
{
        HRESULT hr;
        <span class="keywordflow">try</span>
        {
                m_piGraphan = 0;
                m_piGraphan.CreateInstance(__uuidof(GRAPHANLib::GraphmatFile));
                m_piGraphan-&gt;Language = langua;
                m_piGraphan-&gt;LoadDicts();

                m_piLemmatizer = 0;
                <span class="keywordflow">if</span> (langua == morphRussian)
                        hr = m_piLemmatizer.CreateInstance(__uuidof(LEMMATIZERLib::LemmatizerRussian)); 
                <span class="keywordflow">else</span>
                        <span class="keywordflow">if</span> (langua == morphGerman)
                                hr = m_piLemmatizer.CreateInstance(__uuidof(LEMMATIZERLib::LemmatizerGerman));  
                        <span class="keywordflow">else</span>
                                <span class="keywordflow">if</span> (langua == morphEnglish)
                                        hr = m_piLemmatizer.CreateInstance(__uuidof(LEMMATIZERLib::LemmatizerEnglish)); 
                <span class="keywordflow">if</span>( FAILED(hr) )
                {
                        ErrorMessage(<span class="stringliteral">"CCOMSyntaxHolder"</span>, <span class="stringliteral">"MorphAn has crushed, maybe \"lemmatizer.dll\" is not registered."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }

                
                hr = m_piLemmatizer-&gt;LoadDictionariesRegistry();
                <span class="keywordflow">if</span>( FAILED(hr) )
                {
                        ErrorMessage(<span class="stringliteral">"Can not load morphology dictionaries."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }

                m_pGramTab = 0;
                <span class="keywordflow">if</span> (langua == morphRussian)
                        hr = m_pGramTab.CreateInstance(__uuidof(AGRAMTABLib::RusGramTab));
                <span class="keywordflow">else</span>
                        <span class="keywordflow">if</span> (langua == morphGerman)
                                hr = m_pGramTab.CreateInstance(__uuidof(AGRAMTABLib::GerGramTab));
                        <span class="keywordflow">else</span>
                                <span class="keywordflow">if</span> (langua == morphEnglish)
                                        hr = m_pGramTab.CreateInstance(__uuidof(AGRAMTABLib::EngGramTab));

                <span class="keywordflow">if</span>( FAILED(hr) )
                {
                        ErrorMessage(<span class="stringliteral">"MorphAn has crushed, maybe \"agramtab.dll\" is not registered."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }

                hr = m_pGramTab-&gt;Load();
                <span class="keywordflow">if</span>( FAILED(hr) )
                {
                        ErrorMessage(<span class="stringliteral">"Can not load rusgramtab ."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }
                
        }
        <span class="keywordflow">catch</span>(...)
        {
                ErrorMessage(<span class="stringliteral">"MorphAn has crushed, maybe \"lemmatizer.dll\" is not registered."</span>);
                <span class="keywordflow">return</span> FALSE;
        }

        <span class="keywordflow">try</span>
        {       
                m_piAfterMorphPlmLines = 0;
                m_piBeforeSyntaxPlmLines = 0;
                
                <span class="keywordflow">if</span>( FAILED( m_piMAPost.CreateInstance(__uuidof(MAPOSTLib::MAPost)) ) )
                        ErrorMessage(<span class="stringliteral">"Mapost has crushed, maybe \"Mapost.dll\" is not registered."</span>);

                <span class="keywordflow">if</span> (langua != morphEnglish)
                        m_piMAPost-&gt;Init(langua, m_piLemmatizer, m_pGramTab);

        }
        <span class="keywordflow">catch</span>(...)
        {
                ErrorMessage(<span class="stringliteral">"Postmorphology has crushed, maybe \"MApost.dll\" is not registered."</span>);
                <span class="keywordflow">return</span> FALSE;
        }

        
        <span class="keywordflow">if</span> (!LoadSyntaxModule(langua))
                <span class="keywordflow">return</span> FALSE;

        m_CurrentLanguage = langua;

        <span class="keywordflow">return</span> TRUE;
};

BOOL CCOMSyntaxHolder::BuildBeforeSyntax(string str, BOOL bFile, BOOL bWriteIntermFiles, BOOL bSaveIntermResults)
{
        m_piBeforeSyntaxPlmLines = 0;   
        m_piAfterMorphPlmLines = 0;
        HRESULT hr =  m_piAfterMorphPlmLines.CreateInstance(__uuidof(LEMMATIZERLib::PLMLineCollection));
        m_piAfterMorphPlmLines-&gt;AttachLemmatizer(m_piLemmatizer);

        m_piSentCollection-&gt;ClearSentences();
        string log_path;
        string FileName = <span class="stringliteral">"rossdev.log"</span>;
        <span class="keywordflow">try</span> {
                
                log_path  = GetRegistryString( <span class="stringliteral">"Software\\Dialing\\Logs\\Main"</span> );
                log_path += <span class="stringliteral">"/"</span>;
        }
        <span class="keywordflow">catch</span> (...) {
        };
        <span class="keywordflow">if</span> (bFile)
                <span class="keywordflow">if</span> (!FileExists(str.c_str()))
                {
                        ErrorMessage (Format(<span class="stringliteral">"file %s  is not found"</span>, str.c_str()));
                        <span class="keywordflow">return</span> FALSE;
                };


        COM_TRY
                
                
                <span class="keywordflow">if</span>( bFile )
                        m_piGraphan-&gt;LoadFileToGraphan(_bstr_t(str.c_str()).copy());
                <span class="keywordflow">else</span>
                        m_piGraphan-&gt;LoadStringToGraphan(_bstr_t(str.c_str()).copy());
                

                

        COM_CATCH( <span class="stringliteral">"GraphAn has crushed."</span>);

        
        

        COM_TRY
                m_piAfterMorphPlmLines-&gt;ProcessHyphenWords(m_piGraphan);


                m_piAfterMorphPlmLines-&gt;ProcessPlmLines(m_piGraphan);                           
                <span class="keywordflow">if</span> (bWriteIntermFiles)
                        m_piAfterMorphPlmLines-&gt;SaveToFile(string(log_path+<span class="stringliteral">"before.lem"</span>).c_str()); 

                <span class="keywordflow">if</span> (!bSaveIntermResults)
                        m_piGraphan-&gt;FreeTable();

        
        COM_CATCH( <span class="stringliteral">"MorphAn has crushed."</span>);

        COM_TRY
                <span class="keywordflow">if</span> (m_CurrentLanguage == morphEnglish)
                {
                        m_piBeforeSyntaxPlmLines = 0;
                        m_piBeforeSyntaxPlmLines .CreateInstance(__uuidof(LEMMATIZERLib::PLMLineCollection));
                        m_piBeforeSyntaxPlmLines-&gt;AttachLemmatizer(m_piLemmatizer);                     
                        m_piBeforeSyntaxPlmLines-&gt;CopyItems(m_piAfterMorphPlmLines);
                }
                <span class="keywordflow">else</span>
                        m_piBeforeSyntaxPlmLines = m_piMAPost-&gt;ProcessData(m_piAfterMorphPlmLines);
                <span class="keywordflow">if</span> (bWriteIntermFiles)
                        m_piBeforeSyntaxPlmLines-&gt;SaveToFile(string(log_path+<span class="stringliteral">"after.lem"</span>).c_str()); 

        COM_CATCH( <span class="stringliteral">"PostMorphology has crushed."</span>);
        
        <span class="keywordflow">if</span> (!bSaveIntermResults)
                m_piAfterMorphPlmLines-&gt;Clear();

        <span class="keywordflow">return</span> TRUE;
};

BOOL CCOMSyntaxHolder::BuildSyntax(BOOL bSaveIntermResults)
{
        COM_TRY
                
                assert( !(m_piSentCollection == NULL) );
                HRESULT hr = m_piSentCollection-&gt;raw_ProcessData(m_piBeforeSyntaxPlmLines);
                <span class="keywordflow">if</span>( FAILED(hr) )
                {       
                        m_piBeforeSyntaxPlmLines = 0;
                        ErrorMessage(<span class="stringliteral">"SynAn has crushed."</span>);
                        <span class="keywordflow">return</span> FALSE;
                }
                
                <span class="keywordflow">if</span> (!bSaveIntermResults)
                        m_piBeforeSyntaxPlmLines-&gt;Clear();
                
        

        COM_CATCH( <span class="stringliteral">"SynAn has crushed."</span>)

        return TRUE;
};

BOOL CCOMSyntaxHolder::GetSentencesFromSynAn(string str, BOOL bFile, BOOL bWriteIntermFiles, BOOL bSaveIntermResults)
{
        <span class="keywordflow">if</span> (!BuildBeforeSyntax(str, bFile, bWriteIntermFiles, bSaveIntermResults)) 
                        <span class="keywordflow">return</span> FALSE;

        <span class="keywordflow">return</span> BuildSyntax(bSaveIntermResults);
}

<span class="keywordtype">void</span> CCOMSyntaxHolder::DeleteMorphDicts()
{
        m_piLemmatizer = NULL;  
        m_pGramTab = NULL;      
        m_piSentCollection = NULL;
        m_piGraphan = 0;
        m_piAfterMorphPlmLines = 0;
        m_piBeforeSyntaxPlmLines = 0;
        m_piMAPost = 0;
};


string  GetClauseTypeDescr(MorphLanguageEnum    Language, <span class="keyword">const</span> SYNANLib::IClausePtr&amp; piClause, <span class="keywordtype">int</span> ClauseRootNo) 
{
        <span class="keywordflow">if</span> (ClauseRootNo == -1)
        {
                <span class="keywordflow">if</span> (Language == morphRussian)
                        <span class="keywordflow">return</span> <span class="stringliteral">"осяршую"</span>;
                <span class="keywordflow">else</span>
                        <span class="keywordflow">return</span> <span class="stringliteral">"EMPTY"</span>;
        }
        <span class="keywordflow">else</span>
        {
                <span class="keywordflow">return</span> (<span class="keyword">const</span> <span class="keywordtype">char</span>*)piClause-&gt;ClauseRoots[ClauseRootNo]-&gt;GetDescription();
        }
};
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Tue Feb 7 15:38:47 2006 for Synan by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
